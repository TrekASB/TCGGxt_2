// Legg inn 3D-tekst (screen-ortogonalt) over valgt kum
async function updateBikTextMarkup(modelId, runtimeId, text) {
  if (!API || !API.viewer || !API.markup) return;

  try {
    const boxes = await API.viewer.getObjectBoundingBoxes(modelId, [runtimeId]);
    if (!boxes || !boxes.length) {
      console.warn("Ingen bounding box for objekt:", modelId, runtimeId);
      return;
    }

    const bbox = boxes[0].boundingBox;

    // Størrelse på objekt (for å gjette om enhet er meter eller mm)
    const sizeX = Math.abs(bbox.max.x - bbox.min.x);
    const sizeY = Math.abs(bbox.max.y - bbox.min.y);
    const sizeZ = Math.abs(bbox.max.z - bbox.min.z);
    const maxSize = Math.max(sizeX, sizeY, sizeZ);

    // Heuristikk:
    // - hvis kummen er ~1–5 (typisk meter) -> gang med 1000 = mm
    // - hvis den er 500–5000 (typisk mm) -> behold som det er
    const factor = maxSize < 20 ? 1000.0 : 1.0;

    const centerX = (bbox.min.x + bbox.max.x) / 2;
    const centerY = (bbox.min.y + bbox.max.y) / 2;
    const topZ    = bbox.max.z;

    // Punkt for teksten – litt over kumtopp
    const pick = {
      modelId: modelId,
      objectId: runtimeId,
      positionX: centerX * factor,
      positionY: centerY * factor,
      positionZ: (topZ + 0.30) * factor  // juster høyden om du vil
      // type kan utelates for "point"
    };

    /** @type {import("trimble-connect-workspace-api").TextMarkup} */
    const textMarkup = {
      start: pick,
      end: pick,
      text: text,
      color: { r: 55, g: 130, b: 70, a: 255 }
    };

    // Fjern alle tidligere markups laget av extensionen
    await API.markup.removeMarkups(undefined);

    // Legg til ny tekst-markup
    const result = await API.markup.addTextMarkup([textMarkup]);
    console.log("Text markup lagt til:", result);

  } catch (e) {
    console.error("Feil ved opprettelse av tekstmarkup:", e);
  }
}
