// 3D-tekst + leader-linje i world-space (tekst billboards mot kamera)
async function updateBikTextMarkup(modelId, runtimeId, text) {
  if (!API || !API.viewer || !API.markup) return;

  try {
    const boxes = await API.viewer.getObjectBoundingBoxes(modelId, [runtimeId]);
    if (!boxes || !boxes.length) {
      console.warn("Ingen bounding box for objekt:", modelId, runtimeId);
      return;
    }

    const bbox = boxes[0].boundingBox;

    // ViewerAPI ObjectBoundingBox bruker samme koordinatsystem som modellen,
    // mens MarkupPick.positionX/Y/Z skal være i millimeter.
    const toMm = v => v * 1000.0;

    const centerX_m = (bbox.min.x + bbox.max.x) / 2;
    const centerY_m = (bbox.min.y + bbox.max.y) / 2;
    const topZ_m    =  bbox.max.z;

    // Ankerpunkt (på kum-topp)
    const anchorPick = {
      modelId: modelId,
      objectId: runtimeId,
      type: "point",
      positionX: toMm(centerX_m),
      positionY: toMm(centerY_m),
      positionZ: toMm(topZ_m + 0.01) // liten offset over geometri
    };

    // Tekstpunkt (over kummen)
    const textPick = {
      modelId: modelId,
      objectId: runtimeId,
      type: "point",
      positionX: toMm(centerX_m),
      positionY: toMm(centerY_m),
      positionZ: toMm(topZ_m + 0.30) // høyde på teksten
    };

    // Tekst-markup: world-space posisjon, tekst følger kamera
    /** @type {import("trimble-connect-workspace-api").TextMarkup} */
    const textMarkup = {
      start: textPick,
      end: textPick,
      text: text,
      color: { r: 55, g: 130, b: 70, a: 255 }
      // ev. backgroundColor: { r: 255, g: 255, b: 255, a: 220 },
      // id: 1   // om du vil oppdatere samme markup senere
    };

    // Leader-linje fra tekst ned til kum
    /** @type {import("trimble-connect-workspace-api").LineMarkup} */
    const lineMarkup = {
      start: textPick,
      end: anchorPick,
      color: { r: 55, g: 130, b: 70, a: 255 }
    };

    // Fjern tidligere markups fra denne extensionen
    await API.markup.removeMarkups(undefined);

    // Legg til tekst + linje
    await API.markup.addTextMarkup([textMarkup]);
    await API.markup.addLineMarkups([lineMarkup]);

    console.log("La til BIK-tekst + leader-linje:", { textMarkup, lineMarkup });

  } catch (e) {
    console.error("Feil ved opprettelse av tekst/linje-markup:", e);
  }
}
