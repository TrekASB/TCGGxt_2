<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="UTF-8" />
  <title>MultiProperty Labeler (Klikk objekt)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

  <style>
    :root{
      --primary:#0069d9; --success:#28a745; --danger:#e74c3c; --gray:#6c757d; --border:#e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body{ margin:0; background:#f5f5f7; color:#111827; min-height:100vh; display:flex; flex-direction:column; }
    header{
      display:flex; align-items:center; gap:14px;
      padding:12px 14px; background:#fff; border-bottom:1px solid var(--border);
    }
    .logoBox{
      width:92px; height:92px; border-radius:12px; background:#fff; border:1px solid #eee;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
      box-shadow:0 1px 3px rgba(15,23,42,.08);
      flex:0 0 auto;
    }
    .logoBox img{ width:84px; height:84px; object-fit:contain; display:block; }
    .titleBlock{display:flex; flex-direction:column; gap:2px;}
    .title{font-weight:800; font-size:18px; color:var(--primary); line-height:1.1;}
    .org{font-weight:700; font-size:13px; opacity:.9;}
    .dev{font-size:11px; opacity:.75; font-style:italic;}
    .status{margin-left:auto; font-size:12px; opacity:.85; white-space:nowrap;}

    main{ padding:12px; display:flex; flex-direction:column; gap:10px; }
    .card{
      background:#fff; border-radius:12px; box-shadow:0 1px 3px rgba(15,23,42,.06);
      padding:12px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label{ font-size:13px; font-weight:800; display:flex; align-items:center; gap:8px; }
    select,button{
      border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:13px; background:#fff;
    }
    select{ min-width:260px; max-width:460px; }
    button{
      color:#fff; border:none; cursor:pointer; font-weight:900;
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
    }
    button:disabled{opacity:.55; cursor:not-allowed;}
    #scanButton{background:var(--success);}
    #clearButton{background:var(--danger);}

    .hint{font-size:12px; opacity:.78; line-height:1.5; margin-top:6px;}
    #error{ color:#b91c1c; font-size:12px; min-height:16px; white-space:pre-wrap; }

    table{ width:100%; border-collapse:collapse; font-size:12px; margin-top:8px; }
    th,td{ border-bottom:1px solid #eef2f7; padding:8px 8px; text-align:left; }
    th{ background:#f8fafc; position:sticky; top:0; z-index:1; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted{ opacity:.78; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid #e5e7eb; font-size:12px;}

    .psetGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:10px;
    }
    .psetBox{
      border:1px solid #eef2f7;
      border-radius:12px;
      padding:10px;
      background:#fafafa;
    }
    .psetTitle{
      font-weight:900;
      font-size:13px;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .psetTitle .tag{
      font-size:11px;
      opacity:.8;
      font-weight:700;
      background:#fff;
      border:1px solid #e5e7eb;
      padding:4px 8px;
      border-radius:999px;
    }
    @media (min-width: 980px){
      .psetGrid{ grid-template-columns: 1fr 1fr 1fr; }
      select{ min-width:220px; }
    }
  </style>
</head>

<body>
<header>
  <div class="logoBox">
    <img src="norconsult-logo-black.png" alt="Norconsult logo"
         onerror="this.style.display='none'; this.parentElement.textContent='Norconsult'; this.parentElement.style.fontWeight='900';">
  </div>
  <div class="titleBlock">
    <div class="title">MultiProperty Labeler</div>
    <div class="org">Norconsult Norge</div>
    <div class="dev">Developed by Edin Dzakmic, Norconsult, (AI-assisted development)</div>
  </div>
  <div class="status" id="status">Kobler til Trimble Connect‚Ä¶</div>
</header>

<main>
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <span class="pill">1) Velg Pset A/B/C + Properties ‚Üí 2) Klikk objekt i 3D ‚Üí 3) P√•skrift vises rett over objektet</span>
      <span class="pill">Filtrerer bort: IFCPROJECT / IFCSITE / IFCBUILDING / IFCBUILDINGSTOREY</span>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="scanButton" disabled>üîÑ Oppdater liste</button>
      <button id="clearButton" disabled>üßπ Fjern p√•skrift</button>
      <span class="muted" id="selectionInfo">Klikk et objekt i 3D n√•r du har valgt Pset/properties.</span>
    </div>

    <div class="psetGrid">
      <div class="psetBox">
        <div class="psetTitle">Pset A <span class="tag">inkluderes hvis valgt</span></div>
        <div class="row">
          <label>Property Set:
            <select id="psetA" disabled><option value="">(velg‚Ä¶)</option></select>
          </label>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>P1:<select id="a1" disabled><option value="">(velg‚Ä¶)</option></select></label>
          <label>P2:<select id="a2" disabled><option value="">(velg‚Ä¶)</option></select></label>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>P3:<select id="a3" disabled><option value="">(velg‚Ä¶)</option></select></label>
          <label>P4:<select id="a4" disabled><option value="">(velg‚Ä¶)</option></select></label>
        </div>
      </div>

      <div class="psetBox">
        <div class="psetTitle">Pset B <span class="tag">inkluderes hvis valgt</span></div>
        <div class="row">
          <label>Property Set:
            <select id="psetB" disabled><option value="">(velg‚Ä¶)</option></select>
          </label>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>P1:<select id="b1" disabled><option value="">(velg‚Ä¶)</option></select></label>
          <label>P2:<select id="b2" disabled><option value="">(velg‚Ä¶)</option></select></label>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>P3:<select id="b3" disabled><option value="">(velg‚Ä¶)</option></select></label>
          <label>P4:<select id="b4" disabled><option value="">(velg‚Ä¶)</option></select></label>
        </div>
      </div>

      <div class="psetBox">
        <div class="psetTitle">Pset C <span class="tag">inkluderes hvis valgt</span></div>
        <div class="row">
          <label>Property Set:
            <select id="psetC" disabled><option value="">(velg‚Ä¶)</option></select>
          </label>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>P1:<select id="c1" disabled><option value="">(velg‚Ä¶)</option></select></label>
          <label>P2:<select id="c2" disabled><option value="">(velg‚Ä¶)</option></select></label>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>P3:<select id="c3" disabled><option value="">(velg‚Ä¶)</option></select></label>
          <label>P4:<select id="c4" disabled><option value="">(velg‚Ä¶)</option></select></label>
        </div>
      </div>
    </div>

    <div class="hint">
      <b>NB:</b> P√•skriften lages med <b>API.markup.addTextMarkup</b> og plasseres <b>rett over objektets topp</b> (vertikal lederlinje).
      S√∏rg for at <b>Markups/Annotations</b> er sl√•tt p√• i viewer.
    </div>

    <div id="error"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">Tabell (rekkef√∏lge = valgene dine)</div>
      <div class="muted">Oppdateres n√•r du endrer valg eller klikker objekt.</div>
    </div>

    <div style="max-height:280px; overflow:auto; border:1px solid #eef2f7; border-radius:10px; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th style="width:70px;">Pset</th>
            <th style="width:55px;">#</th>
            <th>Property</th>
            <th>Verdi (valgt objekt)</th>
          </tr>
        </thead>
        <tbody id="propTableBody">
          <tr><td colspan="4" class="muted">Trykk ¬´Oppdater liste¬ª, velg Pset A/B/C + properties, og klikk et objekt i 3D.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<script>
  let API = null;

  // Vi lager kun √©n aktiv markup om gangen, men beholder ogs√• en liste for robust ‚Äúclear‚Äù
  let lastTextMarkupId = null;
  let allMarkupIdsThisSession = [];

  const IGNORE_TYPES = new Set(["IFCPROJECT","IFCSITE","IFCBUILDING","IFCBUILDINGSTOREY"]);

  const els = {
    status: document.getElementById("status"),
    error: document.getElementById("error"),
    scanButton: document.getElementById("scanButton"),
    clearButton: document.getElementById("clearButton"),
    selectionInfo: document.getElementById("selectionInfo"),
    propTableBody: document.getElementById("propTableBody"),

    psetA: document.getElementById("psetA"),
    psetB: document.getElementById("psetB"),
    psetC: document.getElementById("psetC"),

    a: [document.getElementById("a1"),document.getElementById("a2"),document.getElementById("a3"),document.getElementById("a4")],
    b: [document.getElementById("b1"),document.getElementById("b2"),document.getElementById("b3"),document.getElementById("b4")],
    c: [document.getElementById("c1"),document.getElementById("c2"),document.getElementById("c3"),document.getElementById("c4")]
  };

  let availableProps = {}; // psetName -> Set(props)

  function setStatus(msg){ els.status.textContent = msg; }
  function setError(msg){ els.error.textContent = msg || ""; }
  function normStr(v){ return (v===null||v===undefined) ? "" : String(v).trim(); }
  function looksLikeIfcEntityName(v){
    const s = normStr(v).toUpperCase();
    return s.startsWith("IFC") ? s : "";
  }

  function getIfcEntityTypeFromObjectProps(obj){
    const direct = looksLikeIfcEntityName(obj.ifcType || obj.ifcEntity || obj.entityType || obj.type || obj.objectType || obj.className || obj.class);
    if (direct) return direct;

    const wantedPropNames = new Set([
      "IFC TYPE","IFCTYPE","IFC ENTITY","IFCENTITY","ENTITY","ENTITY TYPE","ENTITYTYPE",
      "CLASS","CLASSNAME","OBJECTTYPE","OBJECT TYPE","COMMON TYPE","IFC CLASS","IFCCLASS"
    ]);

    const psets = (obj.properties || []);
    const prioritized=[], others=[];
    for (const ps of psets){
      const n = normStr(ps.name || ps.set).toLowerCase();
      if (n.includes("reference object") || n === "ifc" || n.includes("component attributes")) prioritized.push(ps);
      else others.push(ps);
    }
    for (const ps of prioritized.concat(others)){
      for (const p of (ps.properties || [])){
        const pn = normStr(p.name).toUpperCase();
        if (!wantedPropNames.has(pn)) continue;
        const t = looksLikeIfcEntityName(p.value);
        if (t) return t;
      }
    }
    return "";
  }

  function containsIfcTypeAnywhere(obj, ifcTypeUpper){
    const target = ifcTypeUpper.toUpperCase();
    const directCandidates = [obj.ifcType,obj.ifcEntity,obj.entityType,obj.type,obj.objectType,obj.className,obj.class];
    for (const c of directCandidates){
      const t = looksLikeIfcEntityName(c);
      if (t === target) return true;
    }
    const nameCandidates = [obj.name,obj.objectName];
    for (const c of nameCandidates){
      const s = normStr(c).toUpperCase();
      if (s === target || s.includes(target)) return true;
    }
    for (const ps of (obj.properties || [])){
      const psName = normStr(ps.name || ps.set).toUpperCase();
      if (psName === target) return true;
      for (const p of (ps.properties || [])){
        const pn = normStr(p.name).toUpperCase();
        const pv = normStr(p.value).toUpperCase();
        if (pn === target || pv === target) return true;
        if (pn.includes(target) || pv.includes(target)) return true;
      }
    }
    return false;
  }

  function isIgnoredIfcEntity(obj){
    const t = getIfcEntityTypeFromObjectProps(obj);
    if (t && IGNORE_TYPES.has(t)) return true;
    for (const it of IGNORE_TYPES){
      if (containsIfcTypeAnywhere(obj, it)) return true;
    }
    return false;
  }

  function escapeHtml(s){
    return String(s || "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function getSelectedConfig(){
    // Returnerer i definert rekkef√∏lge: A, B, C og property 1..4 i hver
    const blocks = [
      { key:"A", pset: els.psetA.value, props: els.a.map(x => x.value) },
      { key:"B", pset: els.psetB.value, props: els.b.map(x => x.value) },
      { key:"C", pset: els.psetC.value, props: els.c.map(x => x.value) }
    ];

    // Behold rekkef√∏lge, fjern tomme og duplikater innen hver blokk
    const out = [];
    for (const b of blocks){
      const pset = normStr(b.pset);
      if (!pset) continue;

      const seen = new Set();
      const props = [];
      for (const p of b.props.map(normStr).filter(Boolean)){
        if (seen.has(p)) continue;
        seen.add(p);
        props.push(p);
      }
      if (!props.length) continue;

      out.push({ block: b.key, pset, props });
    }
    return out;
  }

  function findPropValue(objProps, psetName, propName){
    const psets = objProps.properties || [];
    for (const ps of psets){
      const name = ps.name || ps.set || "";
      if (name !== psetName) continue;
      for (const p of (ps.properties || [])){
        if (p.name === propName) return p.value;
      }
    }
    return undefined;
  }

  function updateTable(config, valueMapsPerBlock){
    els.propTableBody.innerHTML = "";

    if (!config.length){
      els.propTableBody.innerHTML = `<tr><td colspan="4" class="muted">Velg minst ett Property Set (A/B/C) og minst √©n property.</td></tr>`;
      return;
    }

    for (const block of config){
      const vm = valueMapsPerBlock ? (valueMapsPerBlock[block.block] || {}) : {};
      block.props.forEach((p, idx) => {
        const val = vm[p];
        const vs = (val === undefined || val === null) ? "" : String(val);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${escapeHtml(block.block)}</b></td>
          <td>${idx+1}</td>
          <td class="mono">${escapeHtml(p)}</td>
          <td>${escapeHtml(vs)}</td>
        `;
        els.propTableBody.appendChild(tr);
      });
    }
  }

  function build3DText(config, valueMapsPerBlock){
    const lines = [];

    for (const block of config){
      const vm = valueMapsPerBlock[block.block] || {};
      const part = [];

      for (const p of block.props){
        const vs = normStr(vm[p]);
        if (vs) part.push(`${p}: ${vs}`);
      }

      if (part.length){
        // Header pr pset-blokk for lesbarhet
        lines.push(`${block.pset}`);
        lines.push(...part);
        lines.push(""); // tom linje mellom blokker
      }
    }

    // fjern trailing tomme linjer
    while (lines.length && normStr(lines[lines.length-1]) === "") lines.pop();
    return lines.join("\n");
  }

  // ---------- Markup helpers ----------
  async function clearTextMarkup(){
    if (!API || !API.markup || typeof API.markup.removeMarkups !== "function") return;

    // 1) fors√∏k √• fjerne siste
    if (lastTextMarkupId != null){
      try{
        await API.markup.removeMarkups([lastTextMarkupId]);
      }catch(err){
        console.warn("removeMarkups(last) feilet:", err);
      }
      lastTextMarkupId = null;
    }

    // 2) fallback: fjerne alt vi har laget (robust)
    if (allMarkupIdsThisSession.length){
      try{
        await API.markup.removeMarkups(allMarkupIdsThisSession.slice());
      }catch(err){
        console.warn("removeMarkups(all) feilet:", err);
      }
      allMarkupIdsThisSession = [];
    }
  }

  async function showTextMarkupOverObject(modelId, runtimeId, text){
    if (!API || !API.markup || typeof API.markup.addTextMarkup !== "function"){
      throw new Error("MarkupAPI (API.markup.addTextMarkup) er ikke tilgjengelig.");
    }

    const boxes = await API.viewer.getObjectBoundingBoxes(modelId, [runtimeId]);
    if (!boxes || !boxes.length || !boxes[0] || !boxes[0].boundingBox){
      throw new Error("Fant ingen boundingBox for objektet (kan ikke plassere tekst).");
    }

    const bb = boxes[0].boundingBox;
    const min = bb.min;
    const max = bb.max;

    // Midt over objektet (X/Z midt), Y er over topp.
    // Dette gir minst ‚Äúside-offset‚Äù.
    const centerX_mm = ((min.x + max.x) / 2.0) * 1000.0;
    const centerZ_mm = ((min.z + max.z) / 2.0) * 1000.0;
    const topY_mm    = (max.y) * 1000.0;

    // Vertikal lederlinje, rett over objektets topp
    const startPick = {
      positionX: centerX_mm,
      positionY: topY_mm + 100.0,   // litt over topp (0.1 m)
      positionZ: centerZ_mm,
      modelId: modelId,
      objectId: runtimeId
    };
    const endPick = {
      positionX: centerX_mm,
      positionY: topY_mm + 650.0,   // kortere enn f√∏r (0.65 m)
      positionZ: centerZ_mm,
      modelId: modelId,
      objectId: runtimeId
    };

    await clearTextMarkup();

    const markup = {
      start: startPick,
      end: endPick,
      text,
      color: { r: 0, g: 0, b: 204, a: 255 }
    };

    const created = await API.markup.addTextMarkup([markup]);
    if (created && created.length && typeof created[0].id === "number"){
      lastTextMarkupId = created[0].id;
      allMarkupIdsThisSession.push(created[0].id);
      els.clearButton.disabled = false;
    }
  }

  // ---------- Populate helpers ----------
  function fillPsetSelect(selectEl, psetNames){
    selectEl.innerHTML = '<option value="">(velg‚Ä¶)</option>';
    for (const n of psetNames){
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      selectEl.appendChild(opt);
    }
    selectEl.disabled = false;
  }

  function fillPropSelects(propSelectEls, props){
    for (const sel of propSelectEls){
      sel.innerHTML = '<option value="">(velg‚Ä¶)</option>';
      for (const p of props){
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
      }
      sel.disabled = false;
    }
  }

  function clearPropSelects(propSelectEls){
    for (const sel of propSelectEls){
      sel.innerHTML = '<option value="">(velg‚Ä¶)</option>';
      sel.disabled = true;
    }
  }

  // ---------- Scan ----------
  async function scanAllPsetsAndProps(){
    setError("");
    setStatus("Skanner modell for Property Sets‚Ä¶");
    availableProps = {};

    // disable
    [els.psetA, els.psetB, els.psetC].forEach(s => { s.disabled = true; s.innerHTML = '<option value="">(velg‚Ä¶)</option>'; });
    clearPropSelects(els.a); clearPropSelects(els.b); clearPropSelects(els.c);

    try{
      const models = await API.viewer.getObjects();
      if (!models || !models.length){
        setStatus("Fant ingen objekter i visningen.");
        return;
      }

      for (const m of models){
        const modelId = String(m.modelId || m.modelid || m["model Id"] || "");
        const objs = m.objects || [];
        if (!modelId || !objs.length) continue;

        const runtimeIds = objs.map(o => o.id);
        const objPropsArr = await API.viewer.getObjectProperties(modelId, runtimeIds);

        for (const objProps of (objPropsArr || [])){
          if (!objProps) continue;
          if (isIgnoredIfcEntity(objProps)) continue;

          for (const pset of (objProps.properties || [])){
            const psetName = pset.name || pset.set || "";
            if (!psetName) continue;
            if (!availableProps[psetName]) availableProps[psetName] = new Set();
            for (const p of (pset.properties || [])){
              if (p.name) availableProps[psetName].add(p.name);
            }
          }
        }
      }

      const psetNames = Object.keys(availableProps).sort((a,b)=>a.localeCompare(b,"nb"));
      if (!psetNames.length){
        setStatus("Ingen Property Sets funnet (etter filtrering).");
        return;
      }

      fillPsetSelect(els.psetA, psetNames);
      fillPsetSelect(els.psetB, psetNames);
      fillPsetSelect(els.psetC, psetNames);

      setStatus("Ferdig. Velg Pset A/B/C + properties, og klikk et objekt i 3D.");
      updateTable(getSelectedConfig(), null);
    }catch(err){
      console.error(err);
      setError("Feil ved skanning: " + (err.message || err));
      setStatus("Kunne ikke skanne.");
    }
  }

  function onPsetChanged(psetSelect, propSelectEls){
    setError("");
    const psetName = normStr(psetSelect.value);
    if (!psetName){
      clearPropSelects(propSelectEls);
      updateTable(getSelectedConfig(), null);
      clearTextMarkup();
      els.clearButton.disabled = true;
      els.selectionInfo.textContent = "Klikk et objekt i 3D n√•r du har valgt Pset/properties.";
      return;
    }

    const props = Array.from(availableProps[psetName] || []).sort((a,b)=>a.localeCompare(b,"nb"));
    fillPropSelects(propSelectEls, props);

    updateTable(getSelectedConfig(), null);
    clearTextMarkup();
    els.clearButton.disabled = true;
    els.selectionInfo.textContent = "Klikk et objekt i 3D for √• vise oppdatert p√•skrift.";
  }

  function onPropChanged(){
    updateTable(getSelectedConfig(), null);
    clearTextMarkup();
    els.clearButton.disabled = true;
    els.selectionInfo.textContent = "Klikk objekt i 3D for √• oppdatere p√•skrift med nye valg.";
  }

  // ---------- Selection handler ----------
  function onWorkspaceEvent(event, payload){
    if (event === "viewer.onSelectionChanged" || event === "selection-changed"){
      handleSelectionChanged(payload).catch(err => {
        console.error(err);
        setError("Feil ved selection: " + (err.message || err));
      });
    }
  }

  async function handleSelectionChanged(payload){
    setError("");

    const config = getSelectedConfig();
    updateTable(config, null);

    if (!config.length){
      els.selectionInfo.textContent = "Velg minst ett Pset (A/B/C) og minst √©n property f√∏r du klikker objekt.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    const selection = (payload && payload.data) || [];
    if (!selection.length){
      els.selectionInfo.textContent = "Ingen objekt valgt. Klikk et objekt i 3D.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    const first = selection[0];
    const modelId = first.modelId;
    const runtimeIds = first.objectRuntimeIds || [];
    if (!modelId || !runtimeIds.length){
      els.selectionInfo.textContent = "Ingen gyldig objekt i utvalget.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    const runtimeId = runtimeIds[0];
    els.selectionInfo.textContent = `Valgt: ModellId ${modelId}, RuntimeId ${runtimeId}. Leser egenskaper‚Ä¶`;

    const propsArr = await API.viewer.getObjectProperties(modelId, [runtimeId]);
    if (!propsArr || !propsArr.length){
      els.selectionInfo.textContent = "Fant ingen egenskaper p√• objektet.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    const objProps = propsArr[0];

    if (isIgnoredIfcEntity(objProps)){
      els.selectionInfo.textContent = "Valgt objekt er et container-objekt (filtrert bort). Velg et annet objekt.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    // Bygg value-maps per blokk
    const valueMaps = {};
    for (const block of config){
      const vm = {};
      for (const p of block.props){
        vm[p] = findPropValue(objProps, block.pset, p);
      }
      valueMaps[block.block] = vm;
    }

    updateTable(config, valueMaps);

    const text = build3DText(config, valueMaps);
    if (!normStr(text)){
      els.selectionInfo.textContent = "Ingen av valgte properties har verdi p√• dette objektet.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    await showTextMarkupOverObject(modelId, runtimeId, text);
    els.selectionInfo.textContent = "‚úÖ Viser p√•skrift rett over objektet (sjekk at Markups/Annotations er p√•).";
  }

  // ---------- Connect ----------
  async function connect(){
    try{
      API = await TrimbleConnectWorkspace.connect(window.parent, onWorkspaceEvent, 30000);
      console.log("Tilkoblet API:", API);

      if (!API.markup || typeof API.markup.addTextMarkup !== "function"){
        setStatus("Tilkoblet (MarkupAPI mangler ‚Äì 3D-tekst st√∏ttes ikke i denne workspacen).");
      } else {
        setStatus("Tilkoblet. Trykk ¬´Oppdater liste¬ª for √• skanne Pset.");
      }

      els.scanButton.disabled = false;
    }catch(err){
      console.error(err);
      setError("Kunne ikke koble til Trimble Connect: " + (err.message || err));
      setStatus("Feil ved tilkobling.");
    }
  }

  // UI wiring
  els.scanButton.onclick = scanAllPsetsAndProps;

  els.clearButton.onclick = async () => {
    await clearTextMarkup();
    els.clearButton.disabled = true;
    els.selectionInfo.textContent = "P√•skrift fjernet. Klikk objekt i 3D for √• vise igjen.";
    setError("");
    setStatus("P√•skrift fjernet.");
  };

  els.psetA.onchange = () => onPsetChanged(els.psetA, els.a);
  els.psetB.onchange = () => onPsetChanged(els.psetB, els.b);
  els.psetC.onchange = () => onPsetChanged(els.psetC, els.c);

  [...els.a, ...els.b, ...els.c].forEach(sel => sel.onchange = onPropChanged);

  // Start
  connect();
</script>
</body>
</html>
