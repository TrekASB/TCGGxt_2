<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="UTF-8" />
  <title>MultiProperty Påskrift</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:#f5f7fa;
    }
    header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 16px;
      background:#fff;
      border-bottom:1px solid #e5e7eb;
    }
    header img{
      width:96px;
      height:96px;
      object-fit:contain;
    }
    h1{font-size:18px;margin:0;color:#0069d9}
    .sub{font-size:12px;opacity:.7}

    main{padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{
      background:#fff;
      border-radius:10px;
      padding:12px;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
    }
    label{font-weight:600;font-size:13px}
    select,button{
      width:100%;
      padding:8px;
      margin-top:4px;
      border-radius:8px;
      border:1px solid #d1d5db;
    }
    button{
      background:#0069d9;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    button.danger{background:#e74c3c}

    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:6px;border-bottom:1px solid #eee}
    tr.click:hover td{background:#eef6ff;cursor:pointer}
    .mono{font-family:ui-monospace,monospace}
  </style>
</head>

<body>
<header>
  <img src="norconsult-logo-black.png" onerror="this.style.display='none'">
  <div>
    <h1>MultiProperty Påskrift</h1>
    <div class="sub">Klikk objekter i modellen → påskrift vises automatisk</div>
  </div>
</header>

<main>
  <!-- CONFIG -->
  <div class="card">
    <label>Property Set A</label>
    <select id="psetA"></select>
    <select id="a1"></select>
    <select id="a2"></select>
    <select id="a3"></select>
    <select id="a4"></select>

    <hr>

    <label>Property Set B</label>
    <select id="psetB"></select>
    <select id="b1"></select>
    <select id="b2"></select>

    <hr>

    <label>Property Set C</label>
    <select id="psetC"></select>
    <select id="c1"></select>

    <button id="clearBtn" class="danger">Fjern påskrift</button>
  </div>

  <!-- TABLE -->
  <div class="card">
    <b>Valgte objekter</b>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Objektnavn</th>
          <th>GUID</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="3">Ingen valgt</td></tr>
      </tbody>
    </table>
  </div>
</main>

<script>
let API;
let lastMarkupIds=[];

const IGNORE=new Set(["IFCPROJECT","IFCSITE","IFCBUILDING","IFCBUILDINGSTOREY"]);

function norm(v){return (v??"").toString().trim();}
function isIgnored(obj){
  const t=(obj.ifcType||"").toUpperCase();
  return IGNORE.has(t);
}

async function connect(){
  API=await TrimbleConnectWorkspace.connect(window.parent,onEvent,30000);
  scanPsets();
}

function onEvent(event,payload){
  if(event.includes("selection")){
    handleSelection(payload.data||[]);
  }
}

async function scanPsets(){
  const models=await API.viewer.getObjects();
  const map={};
  for(const m of models){
    const ids=m.objects.map(o=>o.id);
    const props=await API.viewer.getObjectProperties(m.modelId,ids);
    for(const o of props){
      if(isIgnored(o))continue;
      for(const ps of o.properties||[]){
        map[ps.name]=map[ps.name]||new Set();
        ps.properties.forEach(p=>map[ps.name].add(p.name));
      }
    }
  }
  fill("psetA",map);fill("psetB",map);fill("psetC",map);
}

function fill(id,map){
  const s=document.getElementById(id);
  s.innerHTML="<option></option>";
  Object.keys(map).sort().forEach(n=>{
    s.innerHTML+=`<option>${n}</option>`;
  });
  s.onchange=()=>fillProps(id,map[s.value]||[]);
}

function fillProps(prefix,props){
  ["1","2","3","4"].forEach(i=>{
    const s=document.getElementById(prefix[4]+i);
    if(!s)return;
    s.innerHTML="<option></option>";
    props.forEach(p=>s.innerHTML+=`<option>${p}</option>`);
  });
}

async function handleSelection(sel){
  await clearMarkups();
  const rows=[];
  let i=1;

  for(const s of sel){
    const modelId=s.modelId;
    for(const rid of s.objectRuntimeIds){
      const [o]=await API.viewer.getObjectProperties(modelId,[rid]);
      if(isIgnored(o))continue;

      const text=[];
      [["psetA","a"],["psetB","b"],["psetC","c"]].forEach(([ps,pf])=>{
        const pset=document.getElementById(ps).value;
        if(!pset)return;
        const p=o.properties.find(x=>x.name===pset);
        if(!p)return;
        ["1","2","3","4"].forEach(n=>{
          const prop=document.getElementById(pf+n)?.value;
          if(!prop)return;
          const pv=p.properties.find(x=>x.name===prop)?.value;
          if(pv)text.push(`${prop}: ${pv}`);
        });
      });
      if(!text.length)continue;

      const id=await addText(modelId,rid,text.join("\n"));
      if(id)lastMarkupIds.push(id);

      const guid=(await API.viewer.convertToObjectIds(modelId,[rid]))[0];
      rows.push(`<tr class="click" data-m="${modelId}" data-r="${rid}">
        <td>${i++}</td><td>${o.name||""}</td><td class="mono">${guid}</td></tr>`);
    }
  }

  document.getElementById("tbody").innerHTML=rows.join("")||"<tr><td colspan=3>Ingen data</td></tr>";
  document.querySelectorAll("tr.click").forEach(tr=>{
    tr.onclick=()=>API.viewer.setSelection({
      modelObjectIds:[{modelId:tr.dataset.m,objectRuntimeIds:[+tr.dataset.r]}]
    });
  });
}

async function addText(modelId,rid,text){
  const [b]=await API.viewer.getObjectBoundingBoxes(modelId,[rid]);
  if(!b)return null;
  const c=b.boundingBox;
  return (await API.markup.addTextMarkup([{
    start:{positionX:(c.min.x+c.max.x)/2*1000,positionY:c.max.y*1000+100,positionZ:(c.min.z+c.max.z)/2*1000,modelId,objectId:rid},
    end:{positionX:(c.min.x+c.max.x)/2*1000,positionY:c.max.y*1000+600,positionZ:(c.min.z+c.max.z)/2*1000,modelId,objectId:rid},
    text, color:{r:0,g:0,b:204,a:255}
  }]))[0]?.id;
}

async function clearMarkups(){
  if(lastMarkupIds.length){
    await API.markup.removeMarkups(lastMarkupIds);
    lastMarkupIds=[];
  }
}
document.getElementById("clearBtn").onclick=clearMarkups;

connect();
</script>
</body>
</html>
