<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="UTF-8" />
  <title>MultiProperty Labeler (Klikk objekt)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

  <style>
    :root{
      --primary:#0069d9; --success:#28a745; --danger:#e74c3c; --gray:#6c757d; --border:#e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body{ margin:0; background:#f5f5f7; color:#111827; min-height:100vh; display:flex; flex-direction:column; }
    header{
      display:flex; align-items:center; gap:14px;
      padding:12px 14px; background:#fff; border-bottom:1px solid var(--border);
    }
    .logoBox{
      width:92px; height:92px; border-radius:12px; background:#fff; border:1px solid #eee;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
      box-shadow:0 1px 3px rgba(15,23,42,.08);
      flex:0 0 auto;
    }
    .logoBox img{ width:84px; height:84px; object-fit:contain; display:block; }
    .titleBlock{display:flex; flex-direction:column; gap:2px;}
    .title{font-weight:800; font-size:18px; color:var(--primary); line-height:1.1;}
    .org{font-weight:700; font-size:13px; opacity:.9;}
    .dev{font-size:11px; opacity:.75; font-style:italic;}
    .status{margin-left:auto; font-size:12px; opacity:.85; white-space:nowrap;}

    main{ padding:12px; display:flex; flex-direction:column; gap:10px; }
    .card{
      background:#fff; border-radius:12px; box-shadow:0 1px 3px rgba(15,23,42,.06);
      padding:12px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label{ font-size:13px; font-weight:800; display:flex; align-items:center; gap:8px; }
    select,button{
      border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:13px; background:#fff;
    }
    select{ min-width:260px; max-width:460px; }
    button{
      color:#fff; border:none; cursor:pointer; font-weight:900;
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
    }
    button:disabled{opacity:.55; cursor:not-allowed;}
    #scanButton{background:var(--success);}
    #clearButton{background:var(--danger);}

    .hint{font-size:12px; opacity:.78; line-height:1.5; margin-top:6px;}
    #error{ color:#b91c1c; font-size:12px; min-height:16px; white-space:pre-wrap; }

    table{ width:100%; border-collapse:collapse; font-size:12px; margin-top:8px; }
    th,td{ border-bottom:1px solid #eef2f7; padding:8px 8px; text-align:left; }
    th{ background:#f8fafc; position:sticky; top:0; z-index:1; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted{ opacity:.78; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid #e5e7eb; font-size:12px;}
  </style>
</head>

<body>
<header>
  <div class="logoBox">
    <img src="norconsult-logo-black.png" alt="Norconsult logo"
         onerror="this.style.display='none'; this.parentElement.textContent='Norconsult'; this.parentElement.style.fontWeight='900';">
  </div>
  <div class="titleBlock">
    <div class="title"> Labeler</div>
    <div class="org">Norconsult Norge</div>
    <div class="dev">Developed by Edin Dzakmic, Norconsult, (AI-assisted development)</div>
  </div>
  <div class="status" id="status">Kobler til Trimble Connect‚Ä¶</div>
</header>

<main>
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <span class="pill">1) Velg Pset + Properties ‚Üí 2) Klikk objekt i 3D ‚Üí 3) Tekst vises over objekt</span>
      <span class="pill">Filtrerer bort: IFCPROJECT / IFCSITE / IFCBUILDING / IFCBUILDINGSTOREY</span>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="scanButton" disabled>üîÑ Oppdater liste</button>

      <label>
        Property Set:
        <select id="psetSelect" disabled><option value="">(velg‚Ä¶)</option></select>
      </label>
    </div>

    <div class="row" style="margin-top:10px;">
      <label>Property 1:
        <select id="prop1" disabled><option value="">(velg‚Ä¶)</option></select>
      </label>
      <label>Property 2:
        <select id="prop2" disabled><option value="">(velg‚Ä¶)</option></select>
      </label>
    </div>

    <div class="row" style="margin-top:10px;">
      <label>Property 3:
        <select id="prop3" disabled><option value="">(velg‚Ä¶)</option></select>
      </label>
      <label>Property 4:
        <select id="prop4" disabled><option value="">(velg‚Ä¶)</option></select>
      </label>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="clearButton" disabled>üßπ Fjern 3D-tekst</button>
      <span class="muted" id="selectionInfo">Klikk et objekt i 3D n√•r du har valgt properties.</span>
    </div>

    <div class="hint">
      <b>NB:</b> Tekst tegnes med <b>API.markup.addTextMarkup</b> (samme metode som BIK). S√∏rg for at <b>Markups/Annotations</b> er sl√•tt p√• i viewer.
    </div>

    <div id="error"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">Valgte properties (rekkef√∏lge)</div>
      <div class="muted small">Tabellen oppdateres automatisk n√•r du endrer valg eller klikker objekt.</div>
    </div>

    <div style="max-height:260px; overflow:auto; border:1px solid #eef2f7; border-radius:10px; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th style="width:60px;">#</th>
            <th>Property</th>
            <th>Verdi (for valgt objekt)</th>
          </tr>
        </thead>
        <tbody id="propTableBody">
          <tr><td colspan="3" class="muted">Velg Pset + properties f√∏rst, og klikk deretter et objekt i 3D.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<script>
  let API = null;
  let availableProps = {};
  let lastTextMarkupId = null; // vi viser kun √©n label (p√• valgt objekt)

  const IGNORE_TYPES = new Set(["IFCPROJECT","IFCSITE","IFCBUILDING","IFCBUILDINGSTOREY"]);

  const els = {
    status: document.getElementById("status"),
    error: document.getElementById("error"),
    scanButton: document.getElementById("scanButton"),
    clearButton: document.getElementById("clearButton"),
    psetSelect: document.getElementById("psetSelect"),
    prop1: document.getElementById("prop1"),
    prop2: document.getElementById("prop2"),
    prop3: document.getElementById("prop3"),
    prop4: document.getElementById("prop4"),
    propTableBody: document.getElementById("propTableBody"),
    selectionInfo: document.getElementById("selectionInfo")
  };

  function setStatus(msg){ els.status.textContent = msg; }
  function setError(msg){ els.error.textContent = msg || ""; }
  function normStr(v){ return (v===null||v===undefined) ? "" : String(v).trim(); }
  function looksLikeIfcEntityName(v){
    const s = normStr(v).toUpperCase();
    return s.startsWith("IFC") ? s : "";
  }

  function normalizeName(name) {
    return (name || "")
      .toString()
      .toUpperCase()
      .replace(/[^A-Z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "");
  }

  function getIfcEntityTypeFromObjectProps(obj){
    const direct = looksLikeIfcEntityName(obj.ifcType || obj.ifcEntity || obj.entityType || obj.type || obj.objectType || obj.className || obj.class);
    if (direct) return direct;

    const wantedPropNames = new Set([
      "IFC TYPE","IFCTYPE","IFC ENTITY","IFCENTITY","ENTITY","ENTITY TYPE","ENTITYTYPE",
      "CLASS","CLASSNAME","OBJECTTYPE","OBJECT TYPE","COMMON TYPE","IFC CLASS","IFCCLASS"
    ]);

    const psets = (obj.properties || []);
    const prioritized=[], others=[];
    for (const ps of psets){
      const n = normStr(ps.name || ps.set).toLowerCase();
      if (n.includes("reference object") || n === "ifc" || n.includes("component attributes")) prioritized.push(ps);
      else others.push(ps);
    }
    for (const ps of prioritized.concat(others)){
      for (const p of (ps.properties || [])){
        const pn = normStr(p.name).toUpperCase();
        if (!wantedPropNames.has(pn)) continue;
        const t = looksLikeIfcEntityName(p.value);
        if (t) return t;
      }
    }
    return "";
  }

  function containsIfcTypeAnywhere(obj, ifcTypeUpper){
    const target = ifcTypeUpper.toUpperCase();
    const directCandidates = [obj.ifcType,obj.ifcEntity,obj.entityType,obj.type,obj.objectType,obj.className,obj.class];
    for (const c of directCandidates){
      const t = looksLikeIfcEntityName(c);
      if (t === target) return true;
    }
    const nameCandidates = [obj.name,obj.objectName];
    for (const c of nameCandidates){
      const s = normStr(c).toUpperCase();
      if (s === target || s.includes(target)) return true;
    }
    for (const ps of (obj.properties || [])){
      const psName = normStr(ps.name || ps.set).toUpperCase();
      if (psName === target) return true;
      for (const p of (ps.properties || [])){
        const pn = normStr(p.name).toUpperCase();
        const pv = normStr(p.value).toUpperCase();
        if (pn === target || pv === target) return true;
        if (pn.includes(target) || pv.includes(target)) return true;
      }
    }
    return false;
  }

  function isIgnoredIfcEntity(obj){
    const t = getIfcEntityTypeFromObjectProps(obj);
    if (t && IGNORE_TYPES.has(t)) return true;
    for (const it of IGNORE_TYPES){
      if (containsIfcTypeAnywhere(obj, it)) return true;
    }
    return false;
  }

  function getSelectedPropsInOrder(){
    const arr = [els.prop1.value, els.prop2.value, els.prop3.value, els.prop4.value]
      .map(v => normStr(v))
      .filter(Boolean);
    // Behold rekkef√∏lge, men fjern duplikater ved √• hoppe over neste forekomst
    const seen = new Set();
    const out = [];
    for (const p of arr){
      if (seen.has(p)) continue;
      seen.add(p);
      out.push(p);
    }
    return out;
  }

  function updateTable(props, valueMap){
    els.propTableBody.innerHTML = "";
    if (!props.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="3" class="muted">Velg Pset + properties f√∏rst, og klikk deretter et objekt i 3D.</td>`;
      els.propTableBody.appendChild(tr);
      return;
    }

    props.forEach((p, i) => {
      const v = valueMap ? valueMap[p] : undefined;
      const vs = (v === undefined || v === null) ? "" : String(v);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="mono">${escapeHtml(p)}</td>
        <td>${escapeHtml(vs)}</td>
      `;
      els.propTableBody.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s || "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function findPropValue(objProps, psetName, propName){
    const psets = objProps.properties || [];
    for (const ps of psets){
      const name = ps.name || ps.set || "";
      if (name !== psetName) continue;
      for (const p of (ps.properties || [])){
        if (p.name === propName) return p.value;
      }
    }
    return undefined;
  }

  function build3DText(pset, props, valueMap){
    const lines = [];
    // kun verdier i rekkef√∏lge (ren tekst)
    for (const p of props){
      const v = valueMap[p];
      const vs = normStr(v);
      if (vs) lines.push(`${p}: ${vs}`);
    }
    return lines.join("\n");
  }

  async function clearTextMarkup(){
    try{
      if (!API || !API.markup || typeof API.markup.removeMarkups !== "function") return;
      if (lastTextMarkupId != null){
        await API.markup.removeMarkups([lastTextMarkupId]);
        lastTextMarkupId = null;
      }
    }catch(err){
      console.warn("Klarte ikke √• fjerne markup:", err);
    }
  }

  async function showTextMarkupOverObject(modelId, runtimeId, text){
    if (!API || !API.markup || typeof API.markup.addTextMarkup !== "function"){
      throw new Error("MarkupAPI (API.markup.addTextMarkup) er ikke tilgjengelig.");
    }

    const boxes = await API.viewer.getObjectBoundingBoxes(modelId, [runtimeId]);
    if (!boxes || !boxes.length || !boxes[0] || !boxes[0].boundingBox){
      throw new Error("Fant ingen boundingBox for objektet (kan ikke plassere tekst).");
    }

    const bb = boxes[0].boundingBox;
    const min = bb.min;
    const max = bb.max;

    // Samme som BIK: anta Y=opp og pos i mm
    const centerX_mm = ((min.x + max.x) / 2.0) * 1000.0;
    const centerZ_mm = ((min.z + max.z) / 2.0) * 1000.0;
    const topY_mm    = (max.y) * 1000.0;

    const startPick = {
      positionX: centerX_mm,
      positionY: topY_mm + 200.0,
      positionZ: centerZ_mm,
      modelId: modelId,
      objectId: runtimeId
    };
    const endPick = {
      positionX: centerX_mm,
      positionY: topY_mm + 1200.0,
      positionZ: centerZ_mm,
      modelId: modelId,
      objectId: runtimeId
    };

    await clearTextMarkup();

    const markup = { start: startPick, end: endPick, text, color: { r: 0, g: 0, b: 204, a: 255 } };
    const created = await API.markup.addTextMarkup([markup]);
    if (created && created.length && typeof created[0].id === "number"){
      lastTextMarkupId = created[0].id;
      els.clearButton.disabled = false;
    }
  }

  // ----------------- Scan Pset + properties -----------------
  async function scanProperties(){
    setError("");
    setStatus("Skanner modell for Property Sets‚Ä¶");
    availableProps = {};

    els.psetSelect.disabled = true;
    els.psetSelect.innerHTML = '<option value="">(velg‚Ä¶)</option>';
    [els.prop1, els.prop2, els.prop3, els.prop4].forEach(s => { s.disabled = true; s.innerHTML = '<option value="">(velg‚Ä¶)</option>'; });

    try{
      const models = await API.viewer.getObjects();
      if (!models || !models.length){
        setStatus("Fant ingen objekter i visningen.");
        return;
      }

      for (const m of models){
        const modelId = String(m.modelId || m.modelid || m["model Id"] || "");
        const objs = m.objects || [];
        if (!modelId || !objs.length) continue;

        const runtimeIds = objs.map(o => o.id);
        const objPropsArr = await API.viewer.getObjectProperties(modelId, runtimeIds);

        for (const objProps of (objPropsArr || [])){
          if (!objProps) continue;
          if (isIgnoredIfcEntity(objProps)) continue;

          for (const pset of (objProps.properties || [])){
            const psetName = pset.name || pset.set || "";
            if (!psetName) continue;
            if (!availableProps[psetName]) availableProps[psetName] = new Set();
            for (const p of (pset.properties || [])){
              if (p.name) availableProps[psetName].add(p.name);
            }
          }
        }
      }

      const psetNames = Object.keys(availableProps).sort((a,b)=>a.localeCompare(b,"nb"));
      if (!psetNames.length){
        setStatus("Ingen Property Sets funnet (etter filtrering).");
        return;
      }

      for (const n of psetNames){
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        els.psetSelect.appendChild(opt);
      }
      els.psetSelect.disabled = false;

      setStatus("Ferdig. Velg Property Set, deretter Property 1‚Äì4. Klikk s√• et objekt i 3D.");
    }catch(err){
      console.error(err);
      setError("Feil ved skanning: " + (err.message || err));
      setStatus("Kunne ikke skanne.");
    }
  }

  function populatePropDropdowns(pset){
    const props = (availableProps[pset] ? Array.from(availableProps[pset]) : []).sort((a,b)=>a.localeCompare(b,"nb"));
    const selects = [els.prop1, els.prop2, els.prop3, els.prop4];
    selects.forEach(sel => {
      sel.innerHTML = '<option value="">(velg‚Ä¶)</option>';
      for (const p of props){
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
      }
      sel.disabled = false;
    });

    updateTable(getSelectedPropsInOrder(), null);
  }

  // ----------------- Selection listener -----------------
  function onWorkspaceEvent(event, payload){
    if (event === "viewer.onSelectionChanged" || event === "selection-changed"){
      handleSelectionChanged(payload).catch(err => {
        console.error(err);
        setError("Feil ved selection: " + (err.message || err));
      });
    }
  }

  async function handleSelectionChanged(payload){
    setError("");

    const pset = els.psetSelect.value;
    const props = getSelectedPropsInOrder();

    // Oppdater tabellen uansett (rekkef√∏lge)
    updateTable(props, null);

    // M√• ha valgt Pset + minst √©n property
    if (!pset || !props.length){
      els.selectionInfo.textContent = "Velg PropertySet og minst √©n property f√∏r du klikker objekt i 3D.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    const selection = (payload && payload.data) || [];
    if (!selection.length){
      els.selectionInfo.textContent = "Ingen objekt valgt. Klikk et objekt i 3D.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    const first = selection[0];
    const modelId = first.modelId;
    const runtimeIds = first.objectRuntimeIds || [];

    if (!modelId || !runtimeIds.length){
      els.selectionInfo.textContent = "Ingen gyldig objekt i utvalget.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    const runtimeId = runtimeIds[0];
    els.selectionInfo.textContent = `Valgt: ModellId ${modelId}, RuntimeId ${runtimeId}. Leser egenskaper‚Ä¶`;

    const propsArr = await API.viewer.getObjectProperties(modelId, [runtimeId]);
    if (!propsArr || !propsArr.length){
      els.selectionInfo.textContent = "Fant ingen egenskaper p√• objektet.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    const objProps = propsArr[0];

    // Filtrer bort IFCPROJECT/IFCSITE/IFCBUILDING/IFCBUILDINGSTOREY
    if (isIgnoredIfcEntity(objProps)){
      els.selectionInfo.textContent = "Valgt objekt er et container-objekt (filtrert bort). Velg et annet objekt.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    // Les verdier i riktig rekkef√∏lge
    const valueMap = {};
    for (const p of props){
      valueMap[p] = findPropValue(objProps, pset, p);
    }

    updateTable(props, valueMap);

    const text = build3DText(pset, props, valueMap);
    if (!text){
      els.selectionInfo.textContent = "Ingen av valgte properties har verdi p√• dette objektet.";
      await clearTextMarkup();
      els.clearButton.disabled = true;
      return;
    }

    // Lag 3D tekst (BIK-metoden)
    await showTextMarkupOverObject(modelId, runtimeId, text);
    els.selectionInfo.textContent = "‚úÖ Viser 3D-tekst (sjekk at Markups/Annotations er p√•).";
  }

  async function connect(){
    try{
      API = await TrimbleConnectWorkspace.connect(window.parent, onWorkspaceEvent, 30000);
      console.log("Tilkoblet API:", API);

      if (!API.markup || typeof API.markup.addTextMarkup !== "function"){
        setStatus("Tilkoblet (MarkupAPI mangler ‚Äì 3D-tekst st√∏ttes ikke i denne workspacen).");
      } else {
        setStatus("Tilkoblet. Trykk ¬´Oppdater liste¬ª for √• skanne Pset.");
      }

      els.scanButton.disabled = false;
    }catch(err){
      console.error(err);
      setError("Kunne ikke koble til Trimble Connect: " + (err.message || err));
      setStatus("Feil ved tilkobling.");
    }
  }

  // UI events
  els.scanButton.onclick = scanProperties;

  els.psetSelect.onchange = (e) => {
    setError("");
    const pset = e.target.value;
    populatePropDropdowns(pset);
    clearTextMarkup();
    els.clearButton.disabled = true;
    els.selectionInfo.textContent = "Klikk et objekt i 3D for √• vise 3D-tekst.";
  };

  [els.prop1, els.prop2, els.prop3, els.prop4].forEach(sel => {
    sel.onchange = () => {
      // Oppdater tabell rekkef√∏lge n√•r bruker endrer properties
      updateTable(getSelectedPropsInOrder(), null);
      clearTextMarkup();
      els.clearButton.disabled = true;
      els.selectionInfo.textContent = "Klikk objekt i 3D for √• oppdatere 3D-tekst med nye property-valg.";
    };
  });

  els.clearButton.onclick = async () => {
    await clearTextMarkup();
    els.clearButton.disabled = true;
    els.selectionInfo.textContent = "P√•skrift fjernet. Klikk objekt i 3D for √• vise igjen.";
  };

  connect();
</script>
</body>
</html>
