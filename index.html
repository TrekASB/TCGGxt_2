<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="UTF-8" />
  <title>MultiProperty Checker ‚Äì 3D P√•skrift</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

  <style>
    :root{
      --primary:#0069d9; --success:#28a745; --danger:#e74c3c; --gray:#6c757d; --border:#dee2e6;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body{margin:0;background:#f5f5f7;color:#111827;min-height:100vh;display:flex;flex-direction:column;}
    header{
      display:flex;align-items:center;gap:12px;padding:12px 14px;background:#fff;border-bottom:1px solid #e5e7eb;
      font-size:14px;font-weight:800;flex-wrap:wrap;
    }
    header .status{margin-left:auto;font-weight:500;font-size:12px;opacity:.8;white-space:nowrap;}
    main{padding:12px;display:flex;flex-direction:column;gap:10px;max-width:1100px;}
    .card{background:#fff;border-radius:10px;box-shadow:0 1px 3px rgba(15,23,42,.06);padding:12px 14px;font-size:13px;}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    label{font-weight:700;display:flex;align-items:center;gap:8px;white-space:nowrap;}
    select,button{
      padding:10px 12px;border-radius:8px;border:1px solid var(--border);font-size:13px;
    }
    select{min-width:260px;max-width:520px;background:#fff;}
    button{border:none;cursor:pointer;font-weight:800;color:#fff;display:inline-flex;align-items:center;gap:6px;}
    button:disabled{background:var(--gray);cursor:not-allowed;opacity:.85;}
    #scanBtn{background:var(--success);}
    #clearBtn{background:var(--danger);}
    .muted{opacity:.75}
    .small{font-size:12px}
    #error{color:#b91c1c;font-size:12px;min-height:16px;white-space:pre-wrap;margin-top:6px;}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fafafa;font-size:12px;}
    .props-grid{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px;}
    @media (min-width: 880px){
      .props-grid{grid-template-columns:1fr 1fr;}
    }
    .prop-line{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .prop-line input{transform:scale(1.05);}
    .prop-line select{min-width:320px;max-width:520px;}
    code.kv{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px;
      background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;display:inline-block;
    }
  </style>
</head>

<body>
<header>
  MultiProperty Checker ‚Äì 3D P√•skrift
  <span class="status" id="status">Kobler til Trimble Connect‚Ä¶</span>
</header>

<main>
  <div class="card">
    <div class="row">
      <button id="scanBtn" disabled>üîé Oppdater liste</button>

      <label>
        Property Set:
        <select id="psetSelect" disabled>
          <option value="">(velg‚Ä¶)</option>
        </select>
      </label>

      <button id="clearBtn" disabled>üßπ Fjern p√•skrift</button>

      <span class="pill" id="hint">
        Klikk p√• et objekt i modellen for √• vise p√•skrift (opptil 4 properties).
      </span>
    </div>

    <div class="props-grid">
      <div class="prop-line">
        <label><input type="checkbox" id="cb1"> Property 1:</label>
        <select id="prop1" disabled><option value="">(ingen)</option></select>
      </div>
      <div class="prop-line">
        <label><input type="checkbox" id="cb2"> Property 2:</label>
        <select id="prop2" disabled><option value="">(ingen)</option></select>
      </div>
      <div class="prop-line">
        <label><input type="checkbox" id="cb3"> Property 3:</label>
        <select id="prop3" disabled><option value="">(ingen)</option></select>
      </div>
      <div class="prop-line">
        <label><input type="checkbox" id="cb4"> Property 4:</label>
        <select id="prop4" disabled><option value="">(ingen)</option></select>
      </div>
    </div>

    <div id="error"></div>
  </div>

  <div class="card">
    <div class="small muted" style="line-height:1.45">
      ‚Ä¢ P√•skrift vises kun for <b>valgt objekt</b> (klikk i 3D).<br>
      ‚Ä¢ Filtrerer bort: IFCPROJECT / IFCSITE / IFCBUILDING / IFCBUILDINGSTOREY.<br>
      ‚Ä¢ Krever at <b>Markups/Annotations</b> er sl√•tt p√• i viewer.
    </div>
    <div style="margin-top:10px">
      <div class="small muted">Siste p√•skrift-tekst:</div>
      <code class="kv" id="lastText">(ingen)</code>
    </div>
  </div>
</main>

<script>
  let API = null;

  // ====== State ======
  let availableProps = {};      // { psetName: Set(propNames) }
  let lastTextMarkupId = null;  // id til siste tekst-markup

  // ====== UI refs ======
  const els = {
    status: document.getElementById("status"),
    error: document.getElementById("error"),
    scanBtn: document.getElementById("scanBtn"),
    clearBtn: document.getElementById("clearBtn"),
    psetSelect: document.getElementById("psetSelect"),
    lastText: document.getElementById("lastText")
  };

  const cbIds = ["cb1","cb2","cb3","cb4"];
  const propSelectIds = ["prop1","prop2","prop3","prop4"];

  function setStatus(msg){ els.status.textContent = msg; }
  function setError(msg){ els.error.textContent = msg || ""; }
  function setLastText(msg){ els.lastText.textContent = msg || "(ingen)"; }

  function norm(v){ return (v===null||v===undefined) ? "" : String(v).trim(); }
  function looksIfc(v){ const s = norm(v).toUpperCase(); return s.startsWith("IFC") ? s : ""; }

  // ============================
  // Filter: ignorer container/root entities
  // ============================
  const IGNORE_TYPES = new Set(["IFCPROJECT","IFCSITE","IFCBUILDING","IFCBUILDINGSTOREY"]);

  function containsIfcTypeAnywhere(obj, ifcTypeUpper){
    const target = ifcTypeUpper.toUpperCase();

    const direct = [obj.ifcType, obj.ifcEntity, obj.entityType, obj.type, obj.objectType, obj.className, obj.class];
    for (const c of direct){
      const t = looksIfc(c);
      if (t === target) return true;
    }

    const nameCandidates = [obj.name, obj.objectName];
    for (const c of nameCandidates){
      const s = norm(c).toUpperCase();
      if (s === target || s.includes(target)) return true;
    }

    for (const ps of (obj.properties || [])){
      const psName = norm(ps.name || ps.set).toUpperCase();
      if (psName === target) return true;

      for (const p of (ps.properties || [])){
        const pn = norm(p.name).toUpperCase();
        const pv = norm(p.value).toUpperCase();
        if (pn === target || pv === target) return true;
        if (pn.includes(target) || pv.includes(target)) return true;
      }
    }
    return false;
  }

  function getIfcEntityType(obj){
    const direct = looksIfc(obj.ifcType || obj.ifcEntity || obj.entityType || obj.type || obj.objectType || obj.className || obj.class);
    if (direct) return direct;

    const wanted = new Set([
      "IFC TYPE","IFCTYPE","IFC ENTITY","IFCENTITY","ENTITY","ENTITY TYPE","ENTITYTYPE",
      "CLASS","CLASSNAME","OBJECTTYPE","OBJECT TYPE","COMMON TYPE","IFC CLASS","IFCCLASS"
    ]);

    const psets = obj.properties || [];
    for (const ps of psets){
      for (const p of (ps.properties || [])){
        const pn = norm(p.name).toUpperCase();
        if (!wanted.has(pn)) continue;
        const t = looksIfc(p.value);
        if (t) return t;
      }
    }
    return "";
  }

  function isIgnored(obj){
    const t = getIfcEntityType(obj);
    if (t && IGNORE_TYPES.has(t)) return true;
    for (const it of IGNORE_TYPES){
      if (containsIfcTypeAnywhere(obj, it)) return true;
    }
    return false;
  }
  // ============================

  // ---------- Markup helpers ----------
  async function clearTextMarkup(){
    try{
      if (!API || !API.markup || typeof API.markup.removeMarkups !== "function") return;
      if (lastTextMarkupId != null){
        await API.markup.removeMarkups([lastTextMarkupId]);
        lastTextMarkupId = null;
      }
      els.clearBtn.disabled = true;
      setLastText("(ingen)");
    }catch(e){
      console.warn("Klarte ikke √• fjerne markup:", e);
    }
  }

  async function showTextMarkup(modelId, runtimeId, text){
    if (!API || !API.markup || typeof API.markup.addTextMarkup !== "function"){
      setError("Markup API er ikke tilgjengelig. Kan ikke vise 3D-tekst.");
      return;
    }

    // Bounding box
    const boxes = await API.viewer.getObjectBoundingBoxes(modelId, [runtimeId]);
    if (!boxes || !boxes.length || !boxes[0] || !boxes[0].boundingBox) {
      setError("Fant ikke bounding box for objektet ‚Äì kan ikke plassere p√•skrift.");
      return;
    }

    const bb = boxes[0].boundingBox;
    const min = bb.min, max = bb.max;

    // Antar Y er opp, meter -> mm
    const centerX_mm = ((min.x + max.x) / 2.0) * 1000.0;
    const centerZ_mm = ((min.z + max.z) / 2.0) * 1000.0;
    const topY_mm    = (max.y) * 1000.0;

    const startPick = {
      positionX: centerX_mm,
      positionY: topY_mm + 200.0,
      positionZ: centerZ_mm,
      modelId: modelId,
      objectId: runtimeId
    };
    const endPick = {
      positionX: centerX_mm,
      positionY: topY_mm + 1200.0,
      positionZ: centerZ_mm,
      modelId: modelId,
      objectId: runtimeId
    };

    await clearTextMarkup();

    const textMarkup = {
      start: startPick,
      end: endPick,
      text: text,
      color: { r: 0, g: 0, b: 204, a: 255 }
    };

    const created = await API.markup.addTextMarkup([textMarkup]);
    if (created && created.length && typeof created[0].id === "number"){
      lastTextMarkupId = created[0].id;
      els.clearBtn.disabled = false;
    }
  }

  // ---------- Pset scanning ----------
  function resetPropSelects(){
    propSelectIds.forEach(id => {
      const s = document.getElementById(id);
      s.innerHTML = '<option value="">(ingen)</option>';
      s.disabled = true;
    });
    cbIds.forEach(id => document.getElementById(id).checked = false);
  }

  function populatePropSelects(psetName){
    resetPropSelects();
    if (!psetName || !availableProps[psetName]) return;

    const props = Array.from(availableProps[psetName]).sort((a,b)=>a.localeCompare(b,"nb"));
    propSelectIds.forEach(id => {
      const sel = document.getElementById(id);
      props.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
      });
      sel.disabled = false;
    });

    setStatus("‚úÖ Velg opptil 4 properties. Klikk deretter p√• objekt i modellen for p√•skrift.");
  }

  async function scanModelForPsets(){
    if (!API){ setError("API ikke klar."); return; }
    setError("");
    setStatus("üîç Skanner modell for Property Sets‚Ä¶");

    availableProps = {};
    els.psetSelect.disabled = true;
    resetPropSelects();

    try{
      const models = await API.viewer.getObjects();
      if (!models || !models.length){
        setStatus("‚ÑπÔ∏è Fant ingen objekter i visningen.");
        return;
      }

      for (const m of models){
        const modelId = m.modelId || m.modelid || m["model Id"];
        const objs = m.objects || [];
        if (!modelId || !objs.length) continue;

        const runtimeIds = objs.map(o => o.id);
        const objPropsArr = await API.viewer.getObjectProperties(modelId, runtimeIds);

        for (const obj of (objPropsArr || [])){
          if (isIgnored(obj)) continue;

          for (const ps of (obj.properties || [])){
            const psName = ps.name || ps.set || "";
            if (!psName) continue;

            if (!availableProps[psName]) availableProps[psName] = new Set();
            for (const p of (ps.properties || [])){
              if (p && p.name) availableProps[psName].add(p.name);
            }
          }
        }
      }

      const psets = Object.keys(availableProps).sort((a,b)=>a.localeCompare(b,"nb"));
      els.psetSelect.innerHTML = '<option value="">(velg‚Ä¶)</option>';
      psets.forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        els.psetSelect.appendChild(opt);
      });

      els.psetSelect.disabled = !psets.length;
      setStatus(psets.length ? "‚úÖ Skann ferdig ‚Äì velg Property Set." : "‚ÑπÔ∏è Ingen Property Sets funnet (etter filtrering).");
    }catch(e){
      console.error(e);
      setError("Feil under skanning: " + (e.message || e));
      setStatus("‚ùå Skanning feilet.");
    }
  }

  // ---------- Build label text from selected props ----------
  function getSelectedProps(){
    const selected = [];
    for (let i=1;i<=4;i++){
      const cb = document.getElementById(`cb${i}`);
      const sel = document.getElementById(`prop${i}`);
      if (cb.checked && sel && sel.value){
        selected.push(sel.value);
      }
    }
    return selected;
  }

  function readPropValue(objProps, psetName, propName){
    const psets = objProps.properties || [];
    for (const ps of psets){
      const name = ps.name || ps.set || "";
      if (name !== psetName) continue;

      for (const p of (ps.properties || [])){
        if (p.name === propName){
          const v = p.value;
          if (v === null || v === undefined) return "";
          return String(v).trim();
        }
      }
    }
    return "";
  }

  function buildLabelText(psetName, selectedProps, objProps){
    const lines = [];
    for (const prop of selectedProps){
      const v = readPropValue(objProps, psetName, prop);
      // Vis ogs√• "mangler" tydelig:
      lines.push(`${prop}: ${v ? v : "(mangler)"}`);
    }
    return lines.join("\n");
  }

  // ---------- Selection changed: show markup for clicked object ----------
  async function handleSelectionChanged(payload){
    try{
      setError("");

      const psetName = els.psetSelect.value;
      if (!psetName){
        setStatus("Velg Property Set f√∏rst.");
        await clearTextMarkup();
        return;
      }

      const selectedProps = getSelectedProps();
      if (!selectedProps.length){
        setStatus("Huk av minst √©n property for p√•skrift.");
        await clearTextMarkup();
        return;
      }

      const selection = (payload && payload.data) || [];
      if (!selection.length){
        setStatus("Ingen objekt valgt.");
        await clearTextMarkup();
        return;
      }

      const first = selection[0];
      const modelId = first.modelId;
      const runtimeIds = first.objectRuntimeIds || [];
      if (!modelId || !runtimeIds.length){
        setStatus("Ingen gyldig objekt i utvalget.");
        await clearTextMarkup();
        return;
      }

      const runtimeId = runtimeIds[0];

      // Hent egenskaper kun for valgt objekt
      setStatus("Leser egenskaper for valgt objekt‚Ä¶");
      const arr = await API.viewer.getObjectProperties(modelId, [runtimeId]);
      if (!arr || !arr.length){
        setStatus("Fant ingen egenskaper for objektet.");
        await clearTextMarkup();
        return;
      }

      const objProps = arr[0];

      // Filtrer bort root/container hvis bruker klikker dem
      if (isIgnored(objProps)){
        setStatus("Valgt objekt er et container/root-objekt (filtrert bort).");
        await clearTextMarkup();
        return;
      }

      const text = buildLabelText(psetName, selectedProps, objProps);
      setLastText(text);

      await showTextMarkup(modelId, runtimeId, text);
      setStatus("üè∑Ô∏è P√•skrift vist over valgt objekt. (Klikk p√• nytt objekt for √• oppdatere.)");
    }catch(e){
      console.error(e);
      setError("Feil ved h√•ndtering av valg: " + (e.message || e));
      setStatus("‚ùå Kunne ikke lage p√•skrift.");
    }
  }

  // ---------- Workspace connect + events ----------
  function onWorkspaceEvent(event, payload){
    if (event === "viewer.onSelectionChanged" || event === "selection-changed"){
      handleSelectionChanged(payload);
    }
  }
