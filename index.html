// Lag tekst og strek-markup ved valgt kum.
// Tekst er skjermorientert. Linjen (leader) peker til senter topp av kummen.
async function updateBikTextMarkup(modelId, runtimeId, text) {
  if (!API || !API.viewer || !API.markup) return;

  try {
    const boxes = await API.viewer.getObjectBoundingBoxes(modelId, [runtimeId]);
    if (!boxes || !boxes.length) {
      console.warn("Ingen bounding box for objekt:", modelId, runtimeId);
      return;
    }

    const bbox = boxes[0].boundingBox;
    const centerX = (bbox.min.x + bbox.max.x) / 2;
    const centerY = (bbox.min.y + bbox.max.y) / 2;
    const topZ = bbox.max.z;

    // Punkt på kum der linjen skal treffe
    const anchorPos = {
      x: centerX,
      y: centerY,
      z: topZ + 0.01, // ultra-liten offset for å unngå z-fighting
    };

    // Punkt der teksten skal være (litt høyere)
    const textPos = {
      x: centerX,
      y: centerY,
      z: topZ + 0.30, // juster høyde her
    };

    // === Pick-objekter ===
    const anchorPick = {
      modelId: modelId,
      objectId: runtimeId,
      type: "point",
      positionX: anchorPos.x,
      positionY: anchorPos.y,
      positionZ: anchorPos.z
    };

    const textPick = {
      modelId: modelId,
      objectId: runtimeId,
      type: "point",
      positionX: textPos.x,
      positionY: textPos.y,
      positionZ: textPos.z
    };

    // === Tekst-markup (skjermorientert) ===
    const textMarkup = {
      start: textPick,
      end: textPick,
      text: text,
      color: { r: 55, g: 130, b: 70, a: 255 },
      type: "Text"
    };

    // === Linje (leader) markup ===
    const lineMarkup = {
      start: textPick,
      end: anchorPick,
      color: { r: 55, g: 130, b: 70, a: 255 },
      type: "Line"
    };

    // Fjern gamle markups
    await API.markup.removeMarkups(undefined);

    // Legg til både tekst og linje
    await API.markup.addTextMarkup([textMarkup]);
    await API.markup.addLineMarkup([lineMarkup]);

    console.log("La til tekst + leader line:", { textMarkup, lineMarkup });

  } catch (e) {
    console.error("Feil ved opprettelse av tekst/linje markup:", e);
  }
}
